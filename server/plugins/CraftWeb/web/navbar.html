<!DOCTYPE html>
<div class="navbar-fixed" style="margin-bottom: 10px">
    <nav class="nav-extended z-depth-0" id="navbar">
        <div class="nav-wrapper">
            <a class="brand-logo" href="/">OpenCraft</a>
            <a class="sidenav-trigger" id="sidenav-trigger" data-target="slide-out">
                <i class="mdi mdi-24px mdi-menu" id="trigger"></i>
            </a>
        </div>
        <div class="progress" id="prgs" style="margin-bottom: -3px;margin-top: -1px">
            <div class="indeterminate"></div>
        </div>
    </nav>
</div>

<ul id="slide-out" class="sidenav sidenav-fixed">
    <li>
        <div class="user-view">
            <div class="background blue"></div>
            <a class="circle white-text tooltipped" data-position="right" data-tooltip="用户中心" id="face"></a>
            <a class="white-text name" id="name"></a>
            <a><span class="white-text email" id="gameID"></span></a>
        </div>
    </li>
    <li><a class="waves-effect" id="nav-message"><i class="mdi mdi-message mdi-24px"></i>消息</a></li>
    <li><a class="waves-effect active" id="nav-server"><i class="mdi mdi-server mdi-24px"></i>服务器</a></li>
    <li><a class="waves-effect" id="nav-dir"><i class="mdi mdi-folder-account mdi-24px"></i>玩家文件夹</a></li>
</ul>

<div class="tap-target" data-target="sidenav-trigger">
    <div class="tap-target-content white-text">
        <h5>还没有到头</h5>
        <p>
            您可以点击此处查看更多选项
        </p>
    </div>
</div>

<!-- Chat -->
<div class="bottom-dialog" id="dialog-message">
    <h4 id="chat-title" class="dialog-title">
        服务器全局聊天
        <i class="mdi mdi-help-circle tooltipped right"
           style="font-size: 24px;position: fixed; right: 20px; margin-top: -10px" data-position="bottom"
           data-tooltip="如果认为聊天无响应，可以尝试刷新页面。"></i>
    </h4>
    <div id="chat" style="overflow-y: auto;"></div>
    <div class="input-field row dialog-actionbar" id="chat-input-field">
        <input type="text" id="chat-input" class="col s12">
        <label for="chat-input">聊天栏</label>
        <span class="helper-text red-text" id="chat-helper">错误</span>
        <a class="btn-flat small red-text lighten-1 waves-effect waves-circle col right center-align tooltipped" id="chat-send"
           data-position="left" data-tooltip="发送 (Enter)"></a>
    </div>
</div>

<div class="fixed-action-btn tooltipped" data-position="top" data-tooltip="全局聊天" id="btn-message">
    <a class="btn-floating btn-large waves-effect waves-light materialize-red lighten-1">
        <i class="mdi mdi-comment mdi-light"></i>
    </a>
</div>

<script>
    let navClasses = document.getElementById('navbar').classList,
        tapTarget = M.TapTarget.init(document.getElementsByClassName('tap-target')[0]);
    $(document).on('scroll', function () {
        if (currentPage === 'intro') {
            if (window.pageYOffset > 0) {
                if (navClasses.contains('z-depth-0')) {
                    navClasses.remove('z-depth-0');
                    navClasses.add('z-depth-2')
                }
                if (!isWideScreen()) {
                    if (document.body.scrollHeight - (window.scrollY + document.documentElement.clientHeight) <= 5) {
                        let isShown = Cookies.get('isMenuShown');
                        if (isShown === "false") {
                            tapTarget.open();
                            Cookies.set('isMenuShown', true)
                        }
                    }
                }
            } else {
                if (navClasses.contains('z-depth-2')) {
                    navClasses.remove('z-depth-2');
                    navClasses.add('z-depth-0')
                }
            }
        } else if (!navClasses.contains('z-depth-2')) {
            navClasses.clear();
            navClasses.add('z-depth-2')
        }
    });
    navUpdate = () => {
        let name = $('#name');
        let id = $('#gameID');
        name.empty().append('同步中');
        updateUserData(function () {
            name.empty();
            id.empty();
            if (userData.r === 0) {
                name.append(userData.nickname);
                id.append(userData.ID + "@minecraft");
            } else {
                name.append('点击以登录');
            }
            $('#face').empty().append(getFace());
        }, function () {
            name.empty().append('点击以登录');
            id.empty().append('无法连接到服务器');
        });
    };

    let ele = $('.sidenav');
    M.Sidenav.init(ele, {
        onOpenStart: navUpdate
    });
    let sideNav = M.Sidenav.getInstance(ele);

    $('.tooltipped').tooltip();

    function switchPage(data, page) {
        if (!isWideScreen())
            sideNav.close();

        if (page) {
            if (currentPage === page) {
                return
            }
            currentPage = page
        }

        if (navClasses.contains('z-depth-0')) {
            navClasses.remove('z-depth-0');
            navClasses.add('z-depth-2')
        }

        setTimeout(function () {
            if (typeof onDisable === 'function') {
                onDisable();
                onDisable = undefined
            }
            fadeSwitch(data, document.getElementById('content'), true);
            window.scrollTo(0, 1)
        }, 250);
    }


    let items = [$('#nav-server'), $('#nav-message'), $('#nav-dir'), $('#face')];
    function onclick(index){
        items.forEach((value, i) => {
            if (index === i){
                value.parent().get(0).classList.add('active')
            } else {
                value.parent().get(0).classList.remove('active')
            }
        })
    }
    items[0].click(function () {
        switchPage((callback) => {
            $('#content').load('ui?request=server', callback);
        }, 'server');
        onclick(0);
    });
    items[1].click(function () {
        switchPage((callback) => {
            $('#content').load('ui?request=message', callback);
        }, 'message');
        onclick(1);
    });
    items[2].click(function () {
        switchPage((callback) => {
            $('#content').load('ui?request=playerDir', callback)
        }, 'dir');
        onclick(2);
    });
    items[3].click(function () {
        let target;
        let page;
        if (userData.r === 0) {
            target = 'ui?request=user';
            page = 'user'
        } else {
            target = 'ui?request=login';
            page = 'login'
        }
        switchPage(function (callback) {
            $('#content').load(target, callback)
        }, page);
        onclick(3)
    });

    /** Chat **/
    let chatInput = $('#chat-input'), btnSend = $('#chat-send');
    let messagingDialog = new BottomDialog(document.getElementById('dialog-message'));
    let isSyncStarted = false;
    $('#btn-message').click(() => {
        updateUserData(() => {
            if (userData.r !== -1) {
                messagingDialog.show();
                resizeChat();
                if (!isSyncStarted) {
                    callback();
                    isSyncStarted = true
                }
            } else {
                M.toast({
                    html: '<span>您必须登录才能使用聊天工具</span>',
                    displayLength: 5000
                })
            }
        });
    });

    function resizeChat() {
        let field = document.getElementById('chat-input-field');
        field.style.width = (window.innerWidth - 40) + 'px';
        $.extend(document.getElementById('chat').style, {
            marginTop: (document.getElementById('chat-title').clientHeight) + 'px',
            marginBottom: (field.clientHeight + 10) + 'px'
        })
    }

    window.onresize = resizeChat;

    function enable() {
        btnSend.empty().append('<i class="mdi mdi-send"></i>');
        chatInput.prop('disabled', false)
    }

    function disable() {
        btnSend.empty().append('<div class="preloader-wrapper small active">' +
            '<div class="spinner-layer spinner-blue">' +
            '<div class="circle-clipper left">' +
            '<div class="circle"></div>' +
            '</div><div class="gap-patch">' +
            '<div class="circle"></div>' +
            '</div><div class="circle-clipper right">' +
            '<div class="circle"></div>' +
            '</div>' +
            '</div>' +
            '<div class="spinner-layer spinner-red">' +
            '<div class="circle-clipper left">' +
            '<div class="circle"></div>' +
            '</div><div class="gap-patch">' +
            '<div class="circle"></div>' +
            '</div><div class="circle-clipper right">' +
            '<div class="circle"></div>' +
            '</div>' +
            '</div>' +
            '<div class="spinner-layer spinner-yellow">' +
            '<div class="circle-clipper left">' +
            '<div class="circle"></div>' +
            '</div><div class="gap-patch">' +
            '<div class="circle"></div>' +
            '</div><div class="circle-clipper right">' +
            '<div class="circle"></div>' +
            '</div>' +
            '</div>' +
            '<div class="spinner-layer spinner-green">' +
            '<div class="circle-clipper left">' +
            '<div class="circle"></div>' +
            '</div><div class="gap-patch">' +
            '<div class="circle"></div>' +
            '</div><div class="circle-clipper right">' +
            '<div class="circle"></div>' +
            '</div>' +
            '</div>' +
            '</div>');
        chatInput.prop('disabled', true)
    }

    enable();

    let helper = document.getElementById('chat-helper');
    helper.style.display = 'none';

    function chatError(e) {
        helper.innerText = e;
        helper.style.display = 'inline';
    }

    let send = () => {
        if (!chatInput.val()) {
            chatError('消息不能为空')
        } else {
            disable();

            helper.style.display = 'none';
            let message = chatInput.val();
            chatInput.val(undefined); // Clear the chat
            $.ajax({
                url: 'user?request=chat',
                type: 'POST',
                data: message,
                success: function () {
                    enable();
                },
                error: function (xhr, text) {
                    enable();
                    chatError(text)
                },
                timeout: 5000
            });
            M.updateTextFields()
        }
    };
    btnSend.click(send);
    chatInput.on('keyup', (event) => {
        if (event.keyCode === 13) send()
    });

    // Chat Sync
    let chat = $('#chat');

    function appendChat(data) {
        chat.append('<p>' + data.sender + ': ' + getCustomizedText(data.raw) + '<i class="mdi mdi-chevron-right mdi-18px"></i>' + getCustomizedText(data.translation) + '</p>')
    }

    function appendError(reason) {
        chat.append('<span class="red-text error-retry">' + reason + '。点击重试<a class="btn-flat" onclick="callback();"><i class="mdi mdi-refresh mdi-18px"></i></a></span>')
    }

    function callback() {
        $('.error-retry').remove();
        $.ajax({
            url: 'chat',
            success: function (r) {
                let success = true, element = messagingDialog.element, isOnBottom = element.scrollHeight - element.clientHeight - element.scrollTop <= 10;

                if (r.startsWith('$json:')) {
                    let json = JSON.parse(r.substring(6));
                    if (json.r === 0)
                        appendChat(json);
                    else {
                        success = false;
                        appendError('服务器拒绝了我们的请求，错误代码' + json.r)
                    }
                } else {
                    chat.append('<p>' + getCustomizedText(r) + '</p>');
                }
                if (isOnBottom) {
                    startAnimation(
                        (s) => element.scrollTop = s,
                        element.scrollTop,
                        element.scrollHeight,
                        300
                    )
                }
                if (success) {
                    callback();
                }
            },
            error: function (xhr, status) {
                appendError('无法连接服务器，错误代码' + status)
            }
        })
    }
</script>